  <!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>GoDifferent - Atelier MobilitÃ©</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #F8F9FA;
      color: #1E3A5F;
      min-height: 100vh;
      padding: 20px;
      position: relative;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(30, 58, 95, 0.03) 35px, rgba(30, 58, 95, 0.03) 70px);
      pointer-events: none;
      z-index: 0;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 20px;
    }
    
    h1, h2, h3 {
      color: #1E3A5F;
      margin-bottom: 16px;
    }
    
    h2 {
      font-size: 1.5rem;
      text-align: center;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 14px 16px;
      margin: 10px 0;
      font-size: 16px;
      border: 2px solid #E5E7EB;
      border-radius: 10px;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #FF6B35;
    }
    
    button {
      width: 100%;
      padding: 16px 20px;
      margin: 10px 0;
      font-size: 16px;
      font-weight: 600;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }
    
    .btn-primary {
      background: #FF6B35;
      color: white;
    }
    
    .btn-primary:hover {
      background: #E55A25;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
    }
    
    .btn-secondary {
      background: #06D6A0;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #05C090;
    }
    
    .btn-outline {
      background: white;
      color: #1E3A5F;
      border: 2px solid #1E3A5F;
    }
    
    .btn-outline:hover {
      background: #1E3A5F;
      color: white;
    }
    
    button:disabled {
      background: #E5E7EB;
      color: #9CA3AF;
      cursor: not-allowed;
      transform: none;
    }
    
    .step {
      display: none;
    }
    
    .step.active {
      display: block;
    }
    
    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      padding: 0 10px;
    }
    
    .step-dot {
      width: 40px;
      height: 40px;
      background: white;
      border: 3px solid #E5E7EB;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #9CA3AF;
      transition: all 0.3s ease;
    }
    
    .step-dot.active {
      background: #FF6B35;
      border-color: #FF6B35;
      color: white;
      transform: scale(1.1);
    }
    
    .step-dot.completed {
      background: #06D6A0;
      border-color: #06D6A0;
      color: white;
    }
    
    .qrcode-container {
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      background: #F8F9FA;
      border-radius: 12px;
    }
    
    #qrcode, #qrcodeStep3, #qrcodeStep4, #inviteQrcode, #companyQrcode {
      display: inline-block;
      background: white;
      padding: 16px;
      border-radius: 12px;
      margin: 10px auto;
    }
    
    .participant-card {
      background: #F8F9FA;
      margin: 10px 0;
      padding: 16px;
      border-radius: 12px;
      border-left: 4px solid #06D6A0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .participant-card.target {
      border-left: 4px solid #FFD700;
      background: #FFFBEB;
    }
    
    .participant-card.scanned {
      border-left: 4px solid #06D6A0;
      background: #ECFDF5;
    }
    
    .distance-badge {
      background: #1E3A5F;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .icon-badge {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      margin-right: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .challenge-bubble {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      border-radius: 16px;
      margin: 20px 0;
      text-align: center;
    }
    
    .camera-view {
      display: none;
      text-align: center;
      margin: 20px 0;
    }
    
    .camera-view.active {
      display: block;
    }
    
    video {
      width: 100%;
      max-width: 400px;
      border-radius: 12px;
      background: #000;
    }
    
    .progress-bar {
      height: 8px;
      background: #E5E7EB;
      border-radius: 4px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress {
      height: 100%;
      background: linear-gradient(90deg, #FF6B35, #06D6A0);
      transition: width 0.3s ease;
    }
    
    .alert {
      padding: 16px;
      border-radius: 10px;
      margin: 15px 0;
      display: none;
    }
    
    .alert.show {
      display: block;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .alert-error {
      background: #FEE2E2;
      color: #991B1B;
      border-left: 4px solid #DC2626;
    }
    
    .alert-success {
      background: #ECFDF5;
      color: #065F46;
      border-left: 4px solid #06D6A0;
    }
    
    .alert-info {
      background: #EFF6FF;
      color: #1E40AF;
      border-left: 4px solid #3B82F6;
    }
    
    .navigation-buttons {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }
    
    .navigation-buttons button {
      flex: 1;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .checkbox-group {
      margin: 15px 0;
    }
    
    .checkbox-item {
      display: flex;
      align-items: flex-start;
      padding: 12px;
      margin: 8px 0;
      background: #F8F9FA;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .checkbox-item:hover {
      background: #E5E7EB;
    }
    
    .checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 12px;
      margin-top: 2px;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    .checkbox-item label {
      cursor: pointer;
      flex: 1;
    }
    
    .range-container {
      margin: 20px 0;
    }
    
    input[type="range"] {
      width: 100%;
      height: 8px;
      background: #E5E7EB;
      border-radius: 4px;
      outline: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 24px;
      height: 24px;
      background: #FF6B35;
      border-radius: 50%;
      cursor: pointer;
    }
    
    .range-value {
      text-align: center;
      font-size: 2rem;
      font-weight: 700;
      color: #FF6B35;
      margin: 10px 0;
    }
    
    .admin-floating-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #1E3A5F;
      color: white;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 999;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .admin-floating-btn:hover {
      transform: scale(1.1);
      background: #2D5A8F;
    }
    
    .logo {
      max-width: 200px;
      margin: 0 auto 20px;
      display: block;
      border-radius: 12px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: #F8F9FA;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #FF6B35;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: #6B7280;
      margin-top: 8px;
    }
    
    canvas {
      display: none;
    }
    
    .priority-selector {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      align-items: flex-start;
    }
    
    .priority-selector input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-top: 2px;
      flex-shrink: 0;
    }
    
    .priority-selector label {
      flex: 1;
    }
    
    .priority-selector select {
      width: auto;
      flex: 0 0 60px;
      padding: 8px;
      margin: 0;
    }
    
    .export-section {
      text-align: center;
      padding: 20px;
      background: #ECFDF5;
      border-radius: 12px;
      margin: 20px 0;
    }
    
    .co2-savings {
      background: linear-gradient(135deg, #06D6A0, #059669);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      text-align: center;
    }
    
    .co2-number {
      font-size: 3rem;
      font-weight: 700;
      margin: 10px 0;
    }

    .invite-timer {
      text-align: center;
      font-size: 1.3rem;
      margin: 15px 0;
      padding: 10px;
      background: rgba(255, 152, 0, 0.2);
      border-radius: 12px;
      color: #FF9800;
      font-weight: bold;
    }
    
    .emoji-display {
      font-size: 2rem;
      text-align: center;
      margin: 15px 0;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      color: white;
    }
    
    .leaderboard {
      margin: 20px 0;
    }
    
    .leaderboard-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      margin: 10px 0;
      background: #F8F9FA;
      border-radius: 12px;
      border-left: 4px solid #06D6A0;
    }
    
    .leaderboard-item.first {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      border-left: 4px solid #FF8C00;
    }
    
    .leaderboard-item.second {
      background: linear-gradient(135deg, #C0C0C0, #A9A9A9);
      border-left: 4px solid #808080;
    }
    
    .leaderboard-item.third {
      background: linear-gradient(135deg, #CD7F32, #B8860B);
      border-left: 4px solid #8B4513;
    }
    
    .leaderboard-emoji {
      font-size: 2rem;
      margin-right: 15px;
    }
    
    .leaderboard-score {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1E3A5F;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Notice RGPD -->
    <div id="rgpdNotice" class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
      <p style="font-size: 0.9em; margin-bottom: 15px;">
        â„¹ï¸ Vos donnÃ©es (localisation, mode de transport) sont stockÃ©es temporairement pour l'atelier. 
        Elles seront supprimÃ©es dans les 7 jours. 
        <a href="#" onclick="showRGPDDetails(); return false;" style="color: #FFD700; text-decoration: underline; cursor: pointer;">En savoir plus</a>
      </p>
      <button onclick="acceptRGPD()" style="background: #4CAF50; width: 100%; padding: 14px 20px; border: none; border-radius: 10px; color: white; cursor: pointer; font-weight: bold; font-size: 16px;">
        âœ… J'accepte et je continue
      </button>
    </div>

    <!-- Indicateur d'Ã©tapes -->
    <div class="step-indicator">
      <div class="step-dot active" id="step1Dot">1</div>
      <div class="step-dot" id="step2Dot">2</div>
      <div class="step-dot" id="step3Dot">3</div>
      <div class="step-dot" id="step4Dot">4</div>
      <div class="step-dot" id="step5Dot">5</div>
      <div class="step-dot" id="step6Dot">6</div>
    </div>

    <!-- Ã‰tape 1 : Configuration -->
    <div id="step1" class="step active">
      <div class="card">
        <img src="https://raw.githubusercontent.com/bourgineo-stack/Atelier-mobilit--code/a1efc93d3b6a3fbbf78b258f5368af23c0ee5492/logo1.jpg"
         alt="Logo GoDifferent"
         class="logo">
        
        <h2>ğŸš€ Bienvenue !</h2>
        <p style="text-align: center; margin-bottom: 20px;">Commencez par entrer votre code d'accÃ¨s pour dÃ©marrer l'atelier mobilitÃ©.</p>

        <input type="text" id="accessCodeInput" placeholder="Entrez votre code d'accÃ¨s" />
        <button class="btn-primary" onclick="checkAccessCode()">Valider le code</button>

        <div id="accessError" class="alert alert-error"></div>
        
        <div id="locationSection" style="display: none;">
          <h3 style="margin-top: 30px;">ğŸ“ Votre profil mobilitÃ©</h3>
          <input id="userAddress" placeholder="Votre adresse complÃ¨te" />
          
          <select id="transportMode">
            <option value="">-- SÃ©lectionnez votre mode principal --</option>
            <option value="car-thermal">ğŸš— Voiture thermique</option>
            <option value="car-electric">âš¡ Voiture Ã©lectrique</option>
            <option value="carpool">ğŸš™ Covoiturage</option>
            <option value="train">ğŸš† Train/RER</option>
            <option value="bus">ğŸšŒ Bus/Tram</option>
            <option value="bike">ğŸš² VÃ©lo</option>
            <option value="ebike">ğŸš´ VÃ©lo Ã©lectrique</option>
            <option value="walk">ğŸš¶ Marche</option>
            <option value="remote">ğŸ’» TÃ©lÃ©travail</option>
          </select>
          
          <label style="display: block; margin: 10px 0; font-weight: bold;">â° Votre heure de dÃ©part habituelle :</label>
          <input type="time" id="departureTime" value="07:30" />
          
          <div style="text-align: center; margin: 15px 0;">
            <label>
              <input type="checkbox" id="multimodalCheck" onchange="toggleMultimodal()">
              J'alterne entre plusieurs modes
            </label>
          </div>
          
          <button class="btn-primary" id="saveLocation">Valider ma localisation</button>
        </div>

        <div id="afterLocationSection" style="display: none;">
  <div class="alert alert-success show">
    âœ… Localisation enregistrÃ©e avec succÃ¨s !
  </div>
  
  <div class="emoji-display">
    <p>Votre pseudo de l'atelier :</p>
    <div id="myEmojiDisplay" style="font-size: 3rem; margin: 10px 0;"></div>
    <p style="font-size: 0.9rem; opacity: 0.9;">Pour vous identifier lors des classements et demandes RGPD</p>
  </div>
  
  <div id="addressPreview" style="background: #F8F9FA; padding: 15px; border-radius: 10px; margin: 15px 0;">
            <strong>ğŸ“ Votre adresse :</strong> <span id="detectedAddress"></span>
          </div>

          <button class="btn-secondary" onclick="showInvitePage()">ğŸ“¨ Inviter d'autres participants</button>
          <button class="btn-primary" onclick="showStep(2)">DÃ©buter l'atelier ğŸ®</button>
        </div>
      </div>
    </div>

    <!-- Ã‰tape 2 : Rencontres -->
    <div id="step2" class="step">
  <div class="card">
    <h2>ğŸ¤ Faisons connaissance !</h2>
    <p style="text-align: center; margin-bottom: 20px;">Scannez un maximum de participants pour dÃ©couvrir vos voisins.</p>
    
    <div class="emoji-display">
      <p>Votre pseudo :</p>
      <div id="step2EmojiDisplay" style="font-size: 2rem;"></div>
    </div>
    
    <div class="qrcode-container">
          <p><strong>Votre QR code personnel</strong></p>
          <div id="qrcode"></div>
        </div>

        <div class="camera-view" id="cameraView">
          <video id="video" autoplay playsinline muted></video>
          <button class="btn-outline" style="margin-top: 15px;" onclick="stopAllCameras()">ğŸ›‘ ArrÃªter la camÃ©ra</button>
        </div>

        <button class="btn-primary" id="scanBtn" onclick="startScanLoop('normal')">ğŸ“± Scanner d'autres participants</button>
        
        <div id="scanResult"></div>
        
        <div id="challengeSection" style="display: none;">
          <div class="challenge-bubble">
            <div style="font-size: 1.3rem; margin-bottom: 10px;" id="challengeTitle"></div>
            <div style="font-size: 1.1rem; margin: 15px 0;" id="challengeTask"></div>
            <button class="btn-secondary" id="continueChallengeBtn">âœ… Challenge rÃ©alisÃ© !</button>
          </div>
        </div>

        <div class="progress-bar">
          <div class="progress" id="step2Progress" style="width: 0%"></div>
        </div>
        <p style="text-align: center;"><strong>Personnes scannÃ©es : <span id="scanCount">0</span></strong></p>

        <div class="navigation-buttons">
          <button class="btn-outline" onclick="showStep(1)">â¬…ï¸ Retour</button>
          <button class="btn-primary" onclick="showStep(3)" id="goToStep3" disabled>â¡ï¸ DÃ©fi suivant</button>
        </div>
      </div>
    </div>

    <!-- Ã‰tape 3 : DÃ©fi voisins -->
    <div id="step3" class="step">
      <div class="card">
        <h2>ğŸ¯ Retrouvez vos voisins</h2>
        
        <div style="background: #EFF6FF; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
          <p><strong>ğŸ® Objectif :</strong> Scanner 3 de vos 5 voisins les plus proches</p>
          <p><strong>ğŸ“ RÃ¨gle :</strong> 5 essais maximum</p>
        </div>
        
        <div class="qrcode-container">
          <p><strong>Votre QR code</strong></p>
          <div id="qrcodeStep3"></div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
          <div class="stat-number" id="scoreBadge">0/3</div>
          <div class="stat-label">Voisins trouvÃ©s</div>
          <div style="margin-top: 10px;">Essais restants: <strong id="attemptsLeft">5</strong></div>
        </div>

        <h3>ğŸ¯ Vos 5 voisins les plus proches :</h3>
        <div id="targetList"></div>

        <div class="camera-view" id="gameCameraView">
          <video id="gameVideo" autoplay playsinline muted></video>
          <button class="btn-outline" style="margin-top: 15px;" onclick="stopAllCameras()">ğŸ›‘ ArrÃªter</button>
        </div>

        <button class="btn-primary" id="gameScanBtn" onclick="startScanLoop('game')">ğŸ“± Scanner un voisin</button>
        <div id="gameScanResult"></div>
        <div id="gameResult"></div>

        <div class="navigation-buttons">
          <button class="btn-outline" onclick="showStep(2)">â¬…ï¸ Retour</button>
          <button class="btn-secondary" onclick="resetGame()">ğŸ”„ Recommencer</button>
          <button class="btn-primary" onclick="showStep(4)">â¡ï¸ Suite</button>
        </div>
      </div>
    </div>

    <!-- Ã‰tape 4 : Positionnement -->
    <div id="step4" class="step">
      <div class="card">
        <h2>ğŸ—ºï¸ Positionnement sur la carte</h2>
        
        <div style="background: #EFF6FF; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
          <p>ğŸ“ Des QR codes de repÃ¨re sont disposÃ©s dans la salle</p>
          <p>ğŸ‘¥ Scannez les autres pour connaÃ®tre les distances</p>
          <p>ğŸ“ Positionnez-vous en vous repÃ©rant mutuellement</p>
        </div>
        
        <div class="qrcode-container">
      <p><strong>Votre QR code</strong></p>
      <div id="qrcodeStep4"></div>
    </div>
    
    <div class="camera-view" id="positioningCameraView">
      <video id="positioningVideo" autoplay playsinline muted></video>
      <button class="btn-outline" style="margin-top: 15px;" onclick="stopAllCameras()">ğŸ›‘ ArrÃªter</button>
    </div>
    
    <button class="btn-secondary" id="positioningScanBtn" onclick="startScanLoop('positioning')">ğŸ“± Scanner un participant</button>
    <div id="positioningScanResult"></div>
    
    <div class="navigation-buttons">
          <button class="btn-outline" onclick="showStep(3)">â¬…ï¸ Retour</button>
          <button class="btn-secondary" onclick="showStep(2)">ğŸ“± Scanner</button>
          <button class="btn-primary" onclick="showStep(5)">âœ… Je suis bien placÃ©</button>
        </div>
      </div>
    </div>

    <!-- Ã‰tape 5 : Phase Pelotes -->
    <div id="step5" class="step">
      <div class="card">
        <h2>ğŸ§¶ Phase Pelotes de Laine</h2>
        
        <div style="background: #FFFBEB; padding: 20px; border-radius: 12px; margin: 20px 0;">
          <h3>ğŸ“‹ Instructions :</h3>
          <ol style="margin-left: 20px; margin-top: 10px;">
            <li style="margin: 10px 0;">Prenez votre pelote selon votre mode :
              <ul style="margin-left: 20px; margin-top: 5px;">
                <li>ğŸŸ¡ Jaune foncÃ© = Voiture thermique</li>
                <li>âš¡ Jaune pÃ¢le = Voiture Ã©lectrique</li>
                <li>ğŸŸ¨ Jaune clair = Covoiturage</li>
                <li>ğŸ”µ Bleu = VÃ©lo/Marche</li>
                <li>ğŸŒ¸ Rose = Transport en commun</li>
              </ul>
            </li>
            <li style="margin: 10px 0;">En Ã©quipe, aidez-vous mutuellement Ã  positionner vos trajets</li>
            <li style="margin: 10px 0;">DÃ©roulez votre pelote jusqu'au "lieu de travail" (centre)</li>
            <li style="margin: 10px 0;">Observez qui voyage en mÃªme temps que vous !</li>
          </ol>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalParticipants">0</div>
            <div class="stat-label">Participants</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="avgDistance">0</div>
            <div class="stat-label">Distance moy. (km)</div>
          </div>
        </div>
        
        <div class="navigation-buttons">
          <button class="btn-outline" onclick="showStep(4)">â¬…ï¸ Retour</button>
          <button class="btn-primary" onclick="showStep(6)">â¡ï¸ Mes propositions</button>
        </div>
      </div>
    </div>

    <!-- Ã‰tape 6 : Formulaire propositions -->
    <div id="step6" class="step">
      <div class="card">
        <h2>ğŸ’¡ Vos propositions d'action</h2>
        
        <div style="background: #ECFDF5; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
          <p style="text-align: center;">AprÃ¨s cet atelier, quelles alternatives seriez-vous prÃªt(e) Ã  tester ?</p>
        </div>
        
        <h3>ğŸš€ Alternatives envisagÃ©es</h3>
        <p style="font-size: 0.9rem; color: #6B7280; margin-bottom: 10px;">Cochez plusieurs choix et hiÃ©rarchisez-les (1 = prioritÃ©)</p>
        <div id="alternativesList"></div>
        
        <h3 style="margin-top: 30px;">âš ï¸ Vos contraintes principales</h3>
        <div id="constraintsList"></div>
        
        <h3 style="margin-top: 30px;">ğŸ”“ Leviers pour lever vos freins</h3>
        <div id="leversList"></div>
        
        <h3 style="margin-top: 30px;">ğŸ“Š Votre engagement</h3>
        <div class="range-container">
          <label>Quelle est la probabilitÃ© que vous passiez Ã  l'action ?</label>
          <input type="range" id="commitmentRange" min="0" max="100" value="80" oninput="updateCommitmentValue()">
          <div class="range-value"><span id="commitmentValue">80</span>%</div>
        </div>
        
        <button class="btn-primary" onclick="showCompanyScan()">â¡ï¸ GÃ©nÃ©rer mon rapport</button>
        
        <div class="navigation-buttons">
          <button class="btn-outline" onclick="showStep(5)">â¬…ï¸ Retour</button>
        </div>
      </div>
    </div>

    <!-- Page scan entreprise -->
    <div id="companyScanPage" class="step">
      <div class="card">
        <h2>ğŸ¢ DerniÃ¨re Ã©tape</h2>
        
        <div style="background: #EFF6FF; padding: 20px; border-radius: 12px; margin: 20px 0; text-align: center;">
          <p style="margin-bottom: 15px;">Pour calculer vos Ã©conomies de CO2, scannez le QR code de votre entreprise (affichÃ© par l'animateur)</p>
        </div>
        
        <div class="qrcode-container">
          <p><strong>En attente du scan...</strong></p>
        </div>
        
        <div class="camera-view" id="companyCameraView">
          <video id="companyVideo" autoplay playsinline muted></video>
          <button class="btn-outline" style="margin-top: 15px;" onclick="stopAllCameras()">ğŸ›‘ ArrÃªter</button>
        </div>
        
        <button class="btn-primary" onclick="startScanLoop('company')">ğŸ“± Scanner le QR entreprise</button>
        
        <div class="navigation-buttons">
          <button class="btn-outline" onclick="showStep(6)">â¬…ï¸ Retour</button>
        </div>
      </div>
    </div>

    <!-- Page rapport gÃ©nÃ©rÃ© -->
    <div id="reportPage" class="step">
      <div class="card">
        <h2>ğŸ‰ Votre rapport personnalisÃ©</h2>
        
        <div class="co2-savings">
          <p>ğŸ’š Ã‰conomies potentielles annuelles</p>
          <div class="co2-number" id="co2Savings">0</div>
          <p>kg de CO2 Ã©conomisÃ©s</p>
        </div>
        
        <div class="export-section">
          <h3>ğŸ“„ TÃ©lÃ©chargez votre rapport</h3>
          <p style="margin: 15px 0;">Votre rapport complet contient votre profil, vos voisins proches, vos propositions et vos gains estimÃ©s.</p>
          <button class="btn-primary" onclick="generatePDF()">ğŸ“¥ TÃ©lÃ©charger mon rapport PDF</button>
        </div>
        
        <div class="navigation-buttons">
          <button class="btn-outline" onclick="showStep(6)">â¬…ï¸ Retour</button>
        </div>
      </div>
    </div>

    <!-- Page invitation -->
    <div id="invitePage" class="step">
      <div class="card">
        <h2>ğŸ“¨ Inviter des participants</h2>
        <div id="inviteTimer" class="invite-timer"></div>
        <p style="text-align: center; margin: 20px 0;">Partagez ce QR code pour que d'autres puissent rejoindre l'atelier.</p>
        
        <div class="qrcode-container">
          <div id="inviteQrcode"></div>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
          <button class="btn-secondary" onclick="extendInviteTimer()">â¸ï¸ +30 secondes</button>
          <button class="btn-outline" onclick="showStep(1)">â¬…ï¸ Retour Ã  l'atelier</button>
        </div>
      </div>
    </div>

    <!-- Page admin -->
    <div id="adminPage" class="step">
      <div class="card">
        <h2>ğŸ” Administration</h2>
        
        <div id="adminLogin">
          <input type="password" id="adminPassword" placeholder="Mot de passe administrateur" />
          <button class="btn-primary" onclick="adminLogin()">Se connecter</button>
          <div id="adminError" class="alert alert-error"></div>
        </div>
        
        <div id="adminPanel" style="display: none;">
          <h3>ğŸ¢ QR Code Entreprise</h3>
          <div style="background: #F8F9FA; padding: 15px; border-radius: 10px; margin: 15px 0;">
            <input id="companyAddressInput" placeholder="Adresse de l'entreprise" style="margin-bottom: 10px;" />
            <button class="btn-primary" onclick="generateCompanyQR()">GÃ©nÃ©rer QR entreprise</button>
            
            <div id="companyQRSection" style="display: none;">
              <div class="qrcode-container">
                <div id="companyQrcode"></div>
              </div>
              <p style="text-align: center; font-size: 0.9rem; color: #6B7280;">Affichez ce QR code aux participants</p>
            </div>
         </div>
    
    <h3 style="margin-top: 30px;">ğŸ† Classement des participants</h3>
    <div class="leaderboard" id="leaderboard"></div>
    
    <h3 style="margin-top: 30px;">ğŸ“Š Statistiques de l'atelier</h3>
          <button class="btn-secondary" onclick="refreshAdminStats()">ğŸ”„ Actualiser les donnÃ©es</button>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number" id="adminTotalUsers">0</div>
              <div class="stat-label">Participants</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="adminAvgDistance">0</div>
              <div class="stat-label">Distance moy.</div>
            </div>
          </div>
          
          <div id="adminStats" style="margin: 20px 0;"></div>
          
          <h3 style="margin-top: 30px;">ğŸ“¥ Export des donnÃ©es</h3>
          <button class="btn-primary" onclick="exportExcel()">ğŸ“Š TÃ©lÃ©charger Excel collectif</button>
          
          <h3 style="margin-top: 30px;">âš™ï¸ Configuration Google Sheets</h3>
          <div style="background: #F8F9FA; padding: 15px; border-radius: 10px; margin: 15px 0;">
            <label>URL de votre Google Apps Script :</label>
            <input id="googleScriptUrl" placeholder="https://script.google.com/macros/s/..." style="margin-top: 5px;" />
            <button class="btn-secondary" onclick="saveGoogleScriptUrl()">ğŸ’¾ Enregistrer</button>
            <div id="scriptUrlStatus" style="margin-top: 10px; font-size: 0.9rem;"></div>
          </div>
          
          <h3 style="margin-top: 30px;">âš ï¸ Zone de danger</h3>
          <button class="btn-outline" style="background: #FEE2E2; color: #991B1B; border-color: #DC2626;" onclick="resetAllData()">ğŸ—‘ï¸ RÃ©initialiser toutes les donnÃ©es</button>
        </div>
        
        <div class="navigation-buttons">
          <button class="btn-outline" onclick="showStep(1)">â¬…ï¸ Retour</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal multimodal -->
  <div id="multimodalModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ”„ Modes de transport multiples</h2>
      <p>Vous alternez entre plusieurs modes. PrÃ©cisez votre rÃ©partition :</p>
      
      <label><strong>Mode secondaire</strong></label>
      <select id="transportMode2">
        <option value="">-- SÃ©lectionnez --</option>
        <option value="car-thermal">ğŸš— Voiture thermique</option>
        <option value="car-electric">âš¡ Voiture Ã©lectrique</option>
        <option value="carpool">ğŸš™ Covoiturage</option>
        <option value="train">ğŸš† Train/RER</option>
        <option value="bus">ğŸšŒ Bus/Tram</option>
        <option value="bike">ğŸš² VÃ©lo</option>
        <option value="ebike">ğŸš´ VÃ©lo Ã©lectrique</option>
        <option value="walk">ğŸš¶ Marche</option>
        <option value="remote">ğŸ’» TÃ©lÃ©travail</option>
      </select>
      
      <label style="margin-top: 15px;"><strong>RÃ©partition (jours par semaine)</strong></label>
      <div style="display: flex; gap: 10px; align-items: center;">
        <input type="number" id="mode1Days" min="1" max="5" value="3" style="width: 80px;"> jours mode 1
        <span>/</span>
        <input type="number" id="mode2Days" min="1" max="5" value="2" style="width: 80px;"> jours mode 2
      </div>
      
      <div class="navigation-buttons">
        <button class="btn-outline" onclick="closeMultimodal()">Annuler</button>
        <button class="btn-primary" onclick="saveMultimodal()">Valider</button>
      </div>
    </div>
  </div>

  <!-- Bouton admin flottant -->
  <button class="admin-floating-btn" onclick="showAdminPage()">ğŸ”</button>

  <canvas id="canvas"></canvas>
  <canvas id="gameCanvas"></canvas>
  <canvas id="companyCanvas"></canvas>
  <canvas id="positioningCanvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // ========== CONFIGURATION ==========
    const VALID_ACCESS_CODES = ["25"];
    const ADMIN_PASSWORD = 'mobilite2025';
    const MIN_PARTICIPANTS_REQUIRED = 1;
    
    // Ã‰mojis pour pseudonymes (6 possibles)
    const EMOJI_SET = [
        'ğŸ¦¸', 'ğŸ¼', 'ğŸ¦', 'ğŸ»', 'ğŸ¦Š', 'ğŸ±',   // Originaux
        'ğŸ¯', 'ğŸ¦„', 'ğŸ¸', 'ğŸ¦‰', 'ğŸ™', 'ğŸ¦‹',   // Ajouts colorÃ©s
        'ğŸ¨', 'ğŸ¦’', 'ğŸ¦˜', 'ğŸ¦¥', 'ğŸ²', 'ğŸ¦•'    // Animaux sympas
      ];
    
    const ALTERNATIVES = [
      "Covoiturage rÃ©gulier",
      "Autopartage / Location entre particuliers",
      "Transports en commun (Bus/MÃ©tro/Tram)",
      "Train/RER",
      "VÃ©lo personnel",
      "VÃ©lo Ã©lectrique (VAE)",
      "VÃ©lo de fonction",
      "Trottinette Ã©lectrique âš ï¸ (Pensez Ã  l'assurance !)",
      "Marche Ã  pied",
      "VÃ©lo-taf (combiner vÃ©lo + TC)",
      "TÃ©lÃ©travail partiel",
      "TÃ©lÃ©travail complet",
      "Coworking de proximitÃ©",
      "Horaires dÃ©calÃ©s",
      "Semaine de 4 jours",
      "IntermodalitÃ© (combiner plusieurs modes)",
      "VÃ©hicule Ã©lectrique",
      "Autre (prÃ©cisez)"
    ];
    
    const CONSTRAINTS = [
      "Horaires de travail dÃ©calÃ©s/atypiques",
      "Enfants Ã  dÃ©poser/rÃ©cupÃ©rer",
      "MatÃ©riel/outils Ã  transporter",
      "Distance trop grande (>30 km)",
      "Pas de TC Ã  proximitÃ©",
      "Pas de piste cyclable sÃ©curisÃ©e",
      "Conditions mÃ©tÃ©o dÃ©favorables",
      "ProblÃ¨me de santÃ©/handicap",
      "Besoin de flexibilitÃ© (RDV pro)",
      "Statut cadre/astreintes",
      "CoÃ»t trop Ã©levÃ© des alternatives",
      "Manque d'informations sur les alternatives",
      "Peur de perdre en confort",
      "Zone rurale/pÃ©riurbaine mal desservie",
      "Autre (prÃ©cisez)"
    ];
    
    const LEVERS = [
      "Prime mobilitÃ© durable (FMD)",
      "Prise en charge abonnement TC Ã  75%",
      "Parking vÃ©lo sÃ©curisÃ©",
      "Vestiaire/douches",
      "Bornes de recharge Ã©lectrique",
      "Plateforme covoiturage interne",
      "VÃ©los de fonction/flotte",
      "Formation sensibilisation mobilitÃ©",
      "Horaires amÃ©nagÃ©s",
      "Garage vÃ©lo avec kit rÃ©paration",
      "IndemnitÃ© kilomÃ©trique vÃ©lo (IKV)",
      "Autre (prÃ©cisez)"
    ];

    const miniChallenges = [
      { title: "ğŸ¤ Connecteurs", task: "PrÃ©sentez-vous mutuellement Ã  une 3Ã¨me personne que vous scannerez ensemble", icon: "ğŸ­" },
      { title: "ğŸ”¤ Chasseurs d'initiales", task: "Scannez 2 personnes dont les prÃ©noms commencent par la mÃªme lettre", icon: "ğŸ²" },
      { title: "ğŸ•µï¸ Devine mon adresse", task: "Scannez quelqu'un et tentez de deviner l'adresse qu'il a renseignÃ©e (rue, quartier...)", icon: "ğŸ˜ï¸" },
      { title: "ğŸ†˜ Entraide", task: "Trouvez quelqu'un qui semble perdu ou qui a scannÃ© peu de personnes et aidez-le !", icon: "ğŸ¤²" },
      { title: "ğŸ“¸ Selfie mobilitÃ©", task: "Prenez un selfie crÃ©atif sur le thÃ¨me du transport (devant un vÃ©lo, un panneau, dans une voiture...)", icon: "ğŸ¤³", hasPhoto: true }
    ];
    
    const CO2_FACTORS = {
      'car-thermal': 0.193,
      'car-electric': 0.020,
      'carpool': 0.096,
      'train': 0.006,
      'bus': 0.103,
      'bike': 0,
      'ebike': 0.002,
      'walk': 0,
      'remote': 0
    };
    
    // ========== VARIABLES GLOBALES ==========
    let myCoords = null;
    let myUniqueId = '';
    let myEmoji = '';
    let myTransportMode = '';
    let myTransportMode2 = '';
    let mode1Days = 0;
    let mode2Days = 0;
    let myDepartureTime = '07:30';
    let myFullAddress = '';
    let participants = [];
    let scanning = false;
    let animationFrameId = null;
    let gameTargets = [];
    let scannedTargets = [];
    let attemptsLeft = 5;
    let score = 0;
    let gameActive = false;
    let companyCoords = null;
    let companyAddress = '';
    let rgpdAccepted = false;
    let inviteCountdownInterval = null;
    let googleScriptUrl = '';
    let scanCount = 0;
    
    let selectedAlternatives = {};
    let selectedConstraints = [];
    let selectedLevers = [];
    let commitmentLevel = 80;
    
    // ========== FONCTIONS UTILITAIRES ==========
    function $(id) {
      return document.getElementById(id);
    }
    
    function generateUniqueId() {
      return Math.random().toString(36).substr(2, 15);
    }

    function generateEmojiPseudo() {
      // GÃ©nÃ¨re un pseudo de 3 Ã©mojis alÃ©atoires
      let pseudo = '';
      for (let i = 0; i < 3; i++) {
        pseudo += EMOJI_SET[Math.floor(Math.random() * EMOJI_SET.length)];
      }
      return pseudo;
    }    
    
    function restoreUserData() {
      myUniqueId = localStorage.getItem('myUniqueId');
      if (!myUniqueId) {
        myUniqueId = generateUniqueId();
        localStorage.setItem('myUniqueId', myUniqueId);
      }

      myEmoji = localStorage.getItem('myEmoji');
        if (!myEmoji) {
          myEmoji = generateEmojiPseudo();
          localStorage.setItem('myEmoji', myEmoji);
      }
      
      const savedCoords = localStorage.getItem('userCoords');
      if (savedCoords) {
        myCoords = JSON.parse(savedCoords);
      }
      
      myTransportMode = localStorage.getItem('transportMode') || '';
      myTransportMode2 = localStorage.getItem('transportMode2') || '';
      mode1Days = parseInt(localStorage.getItem('mode1Days') || '0');
      mode2Days = parseInt(localStorage.getItem('mode2Days') || '0');
      myDepartureTime = localStorage.getItem('departureTime') || '07:30';
      googleScriptUrl = localStorage.getItem('googleScriptUrl') || '';

      scanCount = parseInt(localStorage.getItem('scanCount') || '0');
    }
    
    function showError(message) {
      const alert = document.createElement('div');
      alert.className = 'alert alert-error show';
      alert.textContent = message;
      alert.style.position = 'fixed';
      alert.style.top = '20px';
      alert.style.left = '50%';
      alert.style.transform = 'translateX(-50%)';
      alert.style.zIndex = '10000';
      alert.style.maxWidth = '90%';
      document.body.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }
    
    function showSuccess(message) {
      const alert = document.createElement('div');
      alert.className = 'alert alert-success show';
      alert.textContent = message;
      alert.style.position = 'fixed';
      alert.style.top = '20px';
      alert.style.left = '50%';
      alert.style.transform = 'translateX(-50%)';
      alert.style.zIndex = '10000';
      alert.style.maxWidth = '90%';
      document.body.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 3000);
    }

    // ========== GESTION RGPD ==========
    function acceptRGPD() {
      rgpdAccepted = true;
      localStorage.setItem('rgpdAccepted', 'true');
      const notice = $('rgpdNotice');
      if (notice) {
        notice.style.display = 'none';
      }
      showSuccess('âœ… Merci ! Vous pouvez continuer.');
    }

    function showRGPDDetails() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      `;
      
      modal.innerHTML = `
        <div style="background: white; color: #333; padding: 30px; border-radius: 20px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
          <h2 style="color: #667eea; margin-top: 0;">ğŸ”’ Protection de vos donnÃ©es</h2>
          
          <h3>Quelles donnÃ©es collectons-nous ?</h3>
          <ul>
            <li>ğŸ“ CoordonnÃ©es GPS de votre adresse</li>
            <li>ğŸš— Votre mode de transport actuel</li>
            <li>â° Votre heure de dÃ©part habituelle</li>
            <li>ğŸ†” Un identifiant anonyme gÃ©nÃ©rÃ© automatiquement</li>
          </ul>
          
          <h3>Pourquoi ?</h3>
          <p>Ces donnÃ©es permettent de rÃ©aliser l'atelier de maniÃ¨re interactive et de visualiser collectivement les trajets domicile-travail.</p>
          
          <h3>Combien de temps ?</h3>
          <p>Vos donnÃ©es sont conservÃ©es <strong>uniquement pendant la durÃ©e de l'atelier</strong> et supprimÃ©es dans les <strong>7 jours suivants</strong>.</p>
          
          <h3>Qui y a accÃ¨s ?</h3>
          <p>Uniquement l'animateur de l'atelier pour gÃ©nÃ©rer les statistiques collectives. Aucune donnÃ©e n'est partagÃ©e Ã  des tiers.</p>
          
          <h3>Vos droits</h3>
          <p>Vous pouvez Ã  tout moment :</p>
          <ul>
            <li>Demander la suppression de vos donnÃ©es (indiquez votre pseudo emoji ${myEmoji})</li>
            <li>Consulter vos donnÃ©es enregistrÃ©es</li>
            <li>Vous retirer de l'atelier</li>
          </ul>
          
          <p style="margin-top: 20px; font-size: 0.9em; color: #666;">
              Pour exercer ces droits, contactez l'animateur de l'atelier ou envoyez un email avec votre pseudo emoji Ã  : <strong>volt.face@outlook.fr</strong>
          </p>
          
          <button onclick="closeRGPDModal()" style="background: #667eea; color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 16px; cursor: pointer; width: 100%; margin-top: 20px;">
            âœ… J'ai compris
          </button>
        </div>
      `;
      
      modal.id = 'rgpdModal';
      document.body.appendChild(modal);
    }

    function closeRGPDModal() {
      const modal = $('rgpdModal');
      if (modal) {
        modal.remove();
      }
    }

    function checkRGPDStatus() {
      const accepted = localStorage.getItem('rgpdAccepted');
      if (accepted === 'true') {
        const notice = $('rgpdNotice');
        if (notice) {
          notice.style.display = 'none';
        }
        rgpdAccepted = true;
      }
    }
    
    // ========== GOOGLE SHEETS SYNC ==========
    async function sendToGoogleSheets(data) {
      if (!googleScriptUrl) {
        console.warn('Google Script URL non configurÃ©e, sauvegarde locale uniquement');
        return false;
      }
      
      try {
        const response = await fetch(googleScriptUrl, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
        
        console.log('âœ… DonnÃ©es envoyÃ©es Ã  Google Sheets');
        return true;
      } catch (error) {
        console.error('âŒ Erreur envoi Google Sheets:', error);
        return false;
      }
    }
    
    async function getFromGoogleSheets() {
      if (!googleScriptUrl) {
        return null;
      }
      
      try {
        const response = await fetch(googleScriptUrl + '?action=get');
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('âŒ Erreur rÃ©cupÃ©ration Google Sheets:', error);
        return null;
      }
    }
    
    // ========== GESTION CODE D'ACCÃˆS ==========
    function checkAccessCode() {
      const input = $('accessCodeInput');
      const code = input.value.trim();

      if (!rgpdAccepted) {
        showError('âš ï¸ Veuillez accepter la politique de donnÃ©es avant de continuer');
        return;
      }
      
      if (VALID_ACCESS_CODES.includes(code)) {
        $('accessCodeInput').style.display = 'none';
        input.parentElement.querySelector('button').style.display = 'none';
        $('locationSection').style.display = 'block';
      } else {
        showError('âŒ Code d\'accÃ¨s invalide');
        input.value = '';
      }
    }
    
    // ========== GESTION MULTIMODAL ==========
    function toggleMultimodal() {
      const checked = $('multimodalCheck').checked;
      if (checked) {
        $('multimodalModal').classList.add('active');
      }
    }
    
    function closeMultimodal() {
      $('multimodalModal').classList.remove('active');
      $('multimodalCheck').checked = false;
    }
    
    function saveMultimodal() {
      myTransportMode2 = $('transportMode2').value;
      mode1Days = parseInt($('mode1Days').value);
      mode2Days = parseInt($('mode2Days').value);
      
      if (!myTransportMode2) {
        showError('SÃ©lectionnez un mode secondaire');
        return;
      }
      
      if (mode1Days + mode2Days !== 5) {
        showError('Le total doit faire 5 jours');
        return;
      }
      
      localStorage.setItem('transportMode2', myTransportMode2);
      localStorage.setItem('mode1Days', mode1Days);
      localStorage.setItem('mode2Days', mode2Days);
      
      $('multimodalModal').classList.remove('active');
      showSuccess('âœ… Modes multiples enregistrÃ©s');
    }
    
    // ========== GÃ‰OCODAGE ==========
    async function geocode(location) {
      try {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&addressdetails=1`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data || data.length === 0) throw new Error('Localisation non trouvÃ©e');
        
        const firstResult = data[0];
        return { 
          lat: parseFloat(firstResult.lat), 
          lon: parseFloat(firstResult.lon), 
          displayName: firstResult.display_name,
          fullAddress: firstResult.display_name
        };
      } catch (error) {
        throw new Error('Erreur de gÃ©ocodage: ' + error.message);
      }
    }
    
    function haversineKm(aLat, aLon, bLat, bLon) {
      const R = 6371;
      const dLat = (bLat - aLat) * Math.PI / 180;
      const dLon = (bLon - aLon) * Math.PI / 180;
      const A = Math.sin(dLat / 2) ** 2 + Math.cos(aLat * Math.PI / 180) * Math.cos(bLat * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
      return 2 * R * Math.atan2(Math.sqrt(A), Math.sqrt(1 - A));
    }
    
    // ========== GÃ‰NÃ‰RATION QR CODES ==========
    function genMyQRCode(targetElementId = 'qrcode') {
    const qrcodeElement = $(targetElementId);
    if (!qrcodeElement) return;

    qrcodeElement.innerHTML = '';

    const qrData = JSON.stringify({
      id: myUniqueId,
      lat: myCoords.lat,
      lon: myCoords.lon,
      transport: myTransportMode
    });

    try {
      new QRCode(qrcodeElement, {
        text: qrData,
        width: 200,
        height: 200,
        colorDark: '#1E3A5F',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });
    } catch (error) {
      console.error('Erreur QR:', error);
    }
  }
    
    function genInviteQRCode() {
      const inviteQrcode = $('inviteQrcode');
      if (!inviteQrcode) return;
      
      inviteQrcode.innerHTML = '';
      const currentUrl = window.location.href;
      
      try {
        new QRCode(inviteQrcode, {
          text: currentUrl,
          width: 200,
          height: 200,
          colorDark: '#FF6B35',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.L
        });
      } catch (error) {
        console.error('Erreur QR invitation:', error);
      }
    }
    
    async function generateCompanyQR() {
      const addressInput = $('companyAddressInput');
      const address = addressInput.value.trim();
      
      if (!address) {
        showError('Entrez l\'adresse de l\'entreprise');
        return;
      }
      
      try {
        const res = await geocode(address);
        companyCoords = { lat: res.lat, lon: res.lon };
        companyAddress = address; // Stocke juste le nom court
        
        localStorage.setItem('companyCoords', JSON.stringify(companyCoords));
        localStorage.setItem('companyAddress', companyAddress);
        
        const qrcodeElement = $('companyQrcode');
        qrcodeElement.innerHTML = '';
        
        // SOLUTION: QR code avec uniquement les coordonnÃ©es
        const qrData = JSON.stringify({
          type: 'company',
          lat: companyCoords.lat,
          lon: companyCoords.lon
        });
        
        new QRCode(qrcodeElement, {
          text: qrData,
          width: 256,
          height: 256,
          colorDark: '#1E3A5F',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.M // M au lieu de H pour Ã©conomiser de l'espace
        });
        
        $('companyQRSection').style.display = 'block';
        showSuccess('âœ… QR code entreprise gÃ©nÃ©rÃ© !');
        
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    }
    
    // ========== NAVIGATION ==========
    function showStep(stepNumber) {
      document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
      document.querySelectorAll('.step-dot').forEach(dot => {
        dot.classList.remove('active');
      });
      
      for (let i = 1; i < stepNumber; i++) {
        const dot = $(`step${i}Dot`);
        if (dot) dot.classList.add('completed');
      }
      
      const stepElement = $(`step${stepNumber}`);
      const dotElement = $(`step${stepNumber}Dot`);
      
      if (stepElement) stepElement.classList.add('active');
      if (dotElement) dotElement.classList.add('active');
      
      stopAllCameras();
      
      if (stepNumber === 2) {
        setTimeout(() => genMyQRCode('qrcode'), 100);
        if ($('step2EmojiDisplay')) {
          $('step2EmojiDisplay').textContent = myEmoji;
          }
      } else if (stepNumber === 3) {
        initGame();
        setTimeout(() => genMyQRCode('qrcodeStep3'), 100);
      } else if (stepNumber === 4) {
        setTimeout(() => genMyQRCode('qrcodeStep4'), 100);
      } else if (stepNumber === 5) {
        updateStep5Stats();
      } else if (stepNumber === 6) {
        initStep6Form();
      }
      
      window.scrollTo(0, 0);
    }
    
    function showInvitePage() {
      document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
      $('invitePage').classList.add('active');
      genInviteQRCode();
      
      // Timer countdown
      let countdown = 30;
      const timerDisplay = $('inviteTimer');
      
      if (inviteCountdownInterval) {
        clearInterval(inviteCountdownInterval);
      }
      
      inviteCountdownInterval = setInterval(() => {
        countdown--;
        timerDisplay.innerHTML = `â±ï¸ Retour automatique dans <strong>${countdown}s</strong>`;
        
        if (countdown <= 10) {
          timerDisplay.style.color = '#FF5722';
        }
        
        if (countdown <= 0) {
          clearInterval(inviteCountdownInterval);
          showStep(2);
        }
      }, 1000);
      
      window.scrollTo(0, 0);
    }
    
    function extendInviteTimer() {
      if (inviteCountdownInterval) {
        // On ne peut pas vraiment "Ã©tendre" sans refaire toute la logique
        // Solution simple : relancer le timer
        clearInterval(inviteCountdownInterval);
        showInvitePage();
        showSuccess('â±ï¸ Temps prolongÃ© de 30s !');
      }
    }
    
    function showAdminPage() {
      document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
      $('adminPage').classList.add('active');
      $('adminLogin').style.display = 'block';
      $('adminPanel').style.display = 'none';
      $('adminPassword').value = '';
      
      // PrÃ©-remplir l'URL si elle existe
      if (googleScriptUrl) {
        $('googleScriptUrl').value = googleScriptUrl;
      }
      
      window.scrollTo(0, 0);
    }
    
    function showCompanyScan() {
      document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
      $('companyScanPage').classList.add('active');
      window.scrollTo(0, 0);
    }
    
    // ========== STEP 5 STATS ==========
    function updateStep5Stats() {
      const total = participants.length + 1;
      $('totalParticipants').textContent = total;
      
      if (participants.length > 0) {
        const avgDist = participants.reduce((sum, p) => sum + p.distance, 0) / participants.length;
        $('avgDistance').textContent = avgDist.toFixed(1);
      }
    }
    
    // ========== STEP 6 FORM ==========
    function initStep6Form() {
      // Alternatives
      const altList = $('alternativesList');
      altList.innerHTML = '';
      ALTERNATIVES.forEach((alt, i) => {
        const div = document.createElement('div');
        div.className = 'priority-selector';
        div.innerHTML = `
          <input type="checkbox" id="alt${i}" onchange="toggleAlternative(${i}, '${alt.replace(/'/g, "\\'")}')">
          <label for="alt${i}">${alt}</label>
          <select id="altPriority${i}" disabled>
            <option value="">-</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
          </select>
        `;
        altList.appendChild(div);
      });
      
      // Contraintes
      const conList = $('constraintsList');
      conList.innerHTML = '';
      CONSTRAINTS.forEach((con, i) => {
        const div = document.createElement('div');
        div.className = 'checkbox-item';
        div.innerHTML = `
          <input type="checkbox" id="con${i}" onchange="toggleConstraint('${con.replace(/'/g, "\\'")}')">
          <label for="con${i}">${con}</label>
        `;
        conList.appendChild(div);
      });
      
      // Leviers
      const levList = $('leversList');
      levList.innerHTML = '';
      LEVERS.forEach((lev, i) => {
        const div = document.createElement('div');
        div.className = 'checkbox-item';
        div.innerHTML = `
          <input type="checkbox" id="lev${i}" onchange="toggleLever('${lev.replace(/'/g, "\\'")}')">
          <label for="lev${i}">${lev}</label>
        `;
        levList.appendChild(div);
      });
    }
    
    function toggleAlternative(index, name) {
      const checked = $(`alt${index}`).checked;
      const prioritySelect = $(`altPriority${index}`);
      
      if (checked) {
        prioritySelect.disabled = false;
        selectedAlternatives[name] = '';
      } else {
        prioritySelect.disabled = true;
        prioritySelect.value = '';
        delete selectedAlternatives[name];
      }
    }
    
    function toggleConstraint(name) {
      const index = selectedConstraints.indexOf(name);
      if (index > -1) {
        selectedConstraints.splice(index, 1);
      } else {
        selectedConstraints.push(name);
      }
    }
    
    function toggleLever(name) {
      const index = selectedLevers.indexOf(name);
      if (index > -1) {
        selectedLevers.splice(index, 1);
      } else {
        selectedLevers.push(name);
      }
    }
    
    function updateCommitmentValue() {
      commitmentLevel = parseInt($('commitmentRange').value);
      $('commitmentValue').textContent = commitmentLevel;
    }
    
    // ========== CAMÃ‰RA & SCAN ==========
    function stopAllCameras() {
      scanning = false;
      
      document.querySelectorAll('.camera-view').forEach(view => {
        view.classList.remove('active');
      });
      
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }
      
      const videos = ['video', 'gameVideo', 'companyVideo', 'positioningVideo'];
      videos.forEach(videoId => {
        const video = $(videoId);
        if (video && video.srcObject) {
          video.srcObject.getTracks().forEach(track => track.stop());
          video.srcObject = null;
        }
      });
      
      if (inviteCountdownInterval) {
        clearInterval(inviteCountdownInterval);
        inviteCountdownInterval = null;
      }
    }
    
    function startScanLoop(type = 'normal') {
      const videoId = type === 'game' ? 'gameVideo' : 
                type === 'company' ? 'companyVideo' : 
                type === 'positioning' ? 'positioningVideo' : 'video';
      const canvasId = type === 'game' ? 'gameCanvas' : 
                 type === 'company' ? 'companyCanvas' : 
                 type === 'positioning' ? 'positioningCanvas' : 'canvas';
      const cameraViewId = type === 'game' ? 'gameCameraView' : 
                  type === 'company' ? 'companyCameraView' : 
                  type === 'positioning' ? 'positioningCameraView' : 'cameraView';
      const scanBtnId = type === 'game' ? 'gameScanBtn' : 
                  type === 'positioning' ? 'positioningScanBtn' : 'scanBtn';
      
      const video = $(videoId);
      const canvas = $(canvasId);
      const cameraView = $(cameraViewId);
      const scanBtn = $(scanBtnId);
      
      if (!video || !canvas) return;
      
      scanning = true;
      if (scanBtn) scanBtn.style.display = 'none';
      if (cameraView) cameraView.classList.add('active');
      
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      
      navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' }
      }).then(stream => {
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
          video.play().catch(e => console.warn('Play interrompu:', e.message));
        };
        
        const scan = () => {
          if (!scanning) return;
          
          if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
              inversionAttempts: 'attemptBoth',
            });
            
            if (code && code.data) {
              try {
                const parsedData = JSON.parse(code.data);
                
                if (type === 'company') {
                  handleCompanyScan(parsedData);
                  return;
                  } else if (type === 'positioning') {
                    handlePositioningScan(parsedData);
                    return;
                } else if (parsedData.id && parsedData.lat && parsedData.lon) {
                  let handled = false;
                  if (type === 'game') {
                    handled = handleGameScan(parsedData);
                  } else {
                    handled = addParticipant(parsedData);
                  }
                  
                  if (handled) {
                    stopAllCameras();
                  }
                  return;
                }
              } catch (e) {
                console.error('Erreur parsing:', e);
              }
            }
          }
          
          animationFrameId = requestAnimationFrame(scan);
        };
        
        animationFrameId = requestAnimationFrame(scan);
      }).catch(e => {
        console.error('Erreur camÃ©ra:', e);
        showError('Erreur camÃ©ra: ' + e.message);
        stopAllCameras();
      });
    }
    
    // ========== GESTION SCAN ENTREPRISE ==========
    function handleCompanyScan(data) {
      if (data.type === 'company' && data.lat && data.lon) {
        companyCoords = { lat: data.lat, lon: data.lon };
        companyAddress = 'Entreprise';
        
        localStorage.setItem('companyCoords', JSON.stringify(companyCoords));
        localStorage.setItem('companyAddress', companyAddress);
        
        stopAllCameras();
        showSuccess('âœ… Entreprise scannÃ©e !');
        
        calculateAndShowReport();
      }
    }

    // ========== GESTION SCAN POSITIONNEMENT ==========
    function handlePositioningScan(data) {
      if (data.id && data.lat && data.lon) {
        const distance = haversineKm(myCoords.lat, myCoords.lon, data.lat, data.lon);
        showSuccess(`ğŸ“ Distance avec ${data.emoji || 'ğŸ¤–'}: ${distance.toFixed(1)} km`);
        stopAllCameras();
        return true;
      }
      return false;
    }

    
    function calculateAndShowReport() {
      if (!myCoords || !companyCoords) {
        showError('DonnÃ©es manquantes pour le calcul');
        return;
      }
      
      const distance = haversineKm(myCoords.lat, myCoords.lon, companyCoords.lat, companyCoords.lon) * 1.35;
      
      let currentCO2 = 0;
      if (mode1Days > 0 && mode2Days > 0) {
        currentCO2 = (CO2_FACTORS[myTransportMode] * distance * 2 * mode1Days * 52) +
                     (CO2_FACTORS[myTransportMode2] * distance * 2 * mode2Days * 52);
      } else {
        currentCO2 = CO2_FACTORS[myTransportMode] * distance * 2 * 5 * 52;
      }
      
      const potentialSavings = currentCO2 * 0.3 * (commitmentLevel / 100);
      
      $('co2Savings').textContent = Math.round(potentialSavings);
      
      document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
      $('reportPage').classList.add('active');
    }
    
    // ========== GESTION PARTICIPANTS ==========
    function addParticipant(data) {
  const existing = participants.find(p => p.id === data.id);
  if (existing) return false;
  
  const distance = haversineKm(myCoords.lat, myCoords.lon, data.lat, data.lon);
  const participant = {
    id: data.id,
    emoji: 'ğŸ‘¤',
    lat: data.lat,
    lon: data.lon,
    distance,
    transport: data.transport || '',
    timestamp: Date.now()
  };
      
      participants.push(participant);
      participants.sort((a, b) => a.distance - b.distance);
      
      // IncrÃ©menter le compteur de scans
      scanCount++;
      localStorage.setItem('scanCount', scanCount);
      
      // ENVOI GOOGLE SHEETS - Type "scan"
      sendToGoogleSheets({
        type: 'scan',
        scannerId: myUniqueId,
        scannerEmoji: myEmoji,
        scannedId: data.id,
        scannedEmoji: data.emoji,
        distance: distance,
        step: 2,
        totalScans: scanCount
      });
      
      updateProgress();
      showSuccess(`âœ… ${data.emoji} ajoutÃ© ! Distance: ${distance.toFixed(1)} km`);
      
      // CHALLENGE SI MOINS DE 5KM
      if (distance < 5) {
        showRandomChallenge();
      }
      
      const goToStep3 = $('goToStep3');
      if (goToStep3 && participants.length >= MIN_PARTICIPANTS_REQUIRED) {
        goToStep3.disabled = false;
      }
      
      return true;
    }
    
    function showRandomChallenge() {
      const randomChallenge = miniChallenges[Math.floor(Math.random() * miniChallenges.length)];
      const challengeTitle = $('challengeTitle');
      const challengeTask = $('challengeTask');
      const challengeSection = $('challengeSection');
      const continueChallengeBtn = $('continueChallengeBtn');
      
      if (challengeTitle && challengeTask && challengeSection) {
        challengeTitle.textContent = randomChallenge.icon + ' ' + randomChallenge.title;
        challengeTask.textContent = randomChallenge.task;
        
        continueChallengeBtn.onclick = function() {
          challengeSection.style.display = 'none';
          $('scanBtn').style.display = 'block';
        };
        
        challengeSection.style.display = 'block';
        $('scanBtn').style.display = 'none';
      }
    }
    
    function updateProgress() {
      const scanCount = participants.length;
      $('scanCount').textContent = scanCount;
      
      const progress = Math.min((scanCount / 30) * 100, 100);
      $('step2Progress').style.width = `${progress}%`;
    }
    
    // ========== JEU STEP 3 ==========
    function initGame() {
      if (participants.length < MIN_PARTICIPANTS_REQUIRED) {
        showError(`Vous devez scanner au moins ${MIN_PARTICIPANTS_REQUIRED} personne(s) !`);
        setTimeout(() => showStep(2), 2000);
        return;
      }
      
      gameTargets = participants.slice(0, 5);
      scannedTargets = [];
      attemptsLeft = 5;
      score = 0;
      gameActive = true;
      
      updateGameDisplay();
    }
    
    function resetGame() {
      initGame();
    }
    
    function updateGameDisplay() {
      $('scoreBadge').textContent = `${score}/3`;
      $('attemptsLeft').textContent = attemptsLeft;
      
      const targetList = $('targetList');
      targetList.innerHTML = '';
      
      gameTargets.forEach((target, index) => {
        const card = document.createElement('div');
        card.className = 'participant-card';
        
        if (scannedTargets.includes(target.id)) {
          card.classList.add('scanned');
        } else {
          card.classList.add('target');
        }
        
        let medal = '';
        if (index === 0) medal = 'ğŸ¥‡ ';
        else if (index === 1) medal = 'ğŸ¥ˆ ';
        else if (index === 2) medal = 'ğŸ¥‰ ';
        
        card.innerHTML = `
          <div style="display: flex; align-items: center;">
            <div class="icon-badge">${target.emoji}</div>
            <div>
              <strong>${medal}Voisin ${index + 1}</strong><br>
              <small>${target.distance.toFixed(1)} km</small>
            </div>
          </div>
          <div class="distance-badge">${scannedTargets.includes(target.id) ? 'âœ…' : 'ğŸ¯'}</div>
        `;
        targetList.appendChild(card);
      });
      
      checkGameEnd();
    }
    
    function checkGameEnd() {
      if (score >= 3 || attemptsLeft <= 0) {
        gameActive = false;
        const errors = (5 - attemptsLeft) - score;
        
        let title = '';
        if (errors === 0) title = 'ğŸ¯ Expert du covoiturage !';
        else if (errors <= 1) title = 'ğŸš— Pro du covoiturage';
        else if (errors <= 2) title = 'ğŸ‘ Bon partenaire';
        else title = 'ğŸ˜Š Ã€ retenter !';
        
        $('gameResult').innerHTML = `
          <div style="background: #ECFDF5; padding: 20px; border-radius: 12px; margin: 20px 0; text-align: center;">
            <h3 style="color: #065F46;">${title}</h3>
            <p>${score} voisins trouvÃ©s sur 3<br>${errors} erreur(s)</p>
          </div>
        `;
        
        $('gameScanBtn').disabled = true;
        
        // ENVOI GOOGLE SHEETS - Type "game_result"
        sendToGoogleSheets({
          type: 'game_result',
          participantId: myUniqueId,
          score: score,
          attempts: 5 - attemptsLeft,
          errors: errors,
          title: title
        });
      }
    }
    
    function handleGameScan(data) {
      if (!gameActive) return false;
      
      const targetIndex = gameTargets.findIndex(target => target.id === data.id);
      
      if (targetIndex !== -1) {
        if (!scannedTargets.includes(data.id)) {
          scannedTargets.push(data.id);
          score++;
          const distance = haversineKm(myCoords.lat, myCoords.lon, data.lat, data.lon);
          showSuccess(`âœ… Bravo ! Voisin trouvÃ© (${distance.toFixed(1)} km)`);
          
          // ENVOI GOOGLE SHEETS - Scan step 3
          sendToGoogleSheets({
            type: 'scan',
            scannerId: myUniqueId,
            scannedId: data.id,
            distance: distance,
            step: 3
          });
        } else {
          showError("âš ï¸ DÃ©jÃ  scannÃ© !");
        }
      } else {
        showError("âŒ Ce n'est pas un de vos 5 voisins !");
      }
      
      attemptsLeft--;
      updateGameDisplay();
      return true;
    }
    
    // ========== ADMIN ==========
    function adminLogin() {
      const password = $('adminPassword').value;
      const adminError = $('adminError');
      
      if (password === ADMIN_PASSWORD) {
        $('adminLogin').style.display = 'none';
        $('adminPanel').style.display = 'block';
        refreshAdminStats();
        showSuccess('âœ… ConnectÃ© en tant qu\'admin');
      } else {
        adminError.textContent = 'âŒ Mot de passe incorrect';
        adminError.classList.add('show');
        setTimeout(() => {
          adminError.classList.remove('show');
        }, 3000);
      }
    }
    
    async function refreshAdminStats() {
      // Essayer de rÃ©cupÃ©rer depuis Google Sheets
      let leaderboard = [];
      const sheetData = await getFromGoogleSheets();
      
      if (sheetData && sheetData.participants) {
        // Utiliser les donnÃ©es du sheet
        const allParticipants = sheetData.participants;
        const total = allParticipants.length;
        $('adminTotalUsers').textContent = total;

        // Construire le classement depuis Google Sheets
        const participantScans = {};

        if (sheetData.scans) {
        sheetData.scans.forEach(scan => {
            const emoji = scan.scannerEmoji || scan.emoji;
          if (!participantScans[emoji]) {
            participantScans[emoji] = 0;
            }
            participantScans[emoji]++;
          });
      }

      leaderboard = Object.entries(participantScans)
        .map(([emoji, count]) => ({ emoji, count }))
        .sort((a, b) => b.count - a.count);
        
        if (total > 1) {
          // Calculer stats depuis sheet data
          let totalDist = 0;
          let count = 0;
          
          allParticipants.forEach(p => {
            if (p.distance) {
              totalDist += parseFloat(p.distance);
              count++;
            }
          });
          
          if (count > 0) {
            $('adminAvgDistance').textContent = (totalDist / count).toFixed(1) + ' km';
          }
          
          // Stats modes de transport
          const transportCounts = {};
          allParticipants.forEach(p => {
            if (p.transport) {
              transportCounts[p.transport] = (transportCounts[p.transport] || 0) + 1;
            }
          });
          
          let statsHTML = '<h4>RÃ©partition modes de transport :</h4>';
          Object.entries(transportCounts).forEach(([mode, count]) => {
            statsHTML += `<p>${mode}: ${count} (${Math.round(count/total*100)}%)</p>`;
          });
          
          $('adminStats').innerHTML = statsHTML;
        }
      } else {
        // Fallback sur localStorage
        const total = participants.length + 1;
        $('adminTotalUsers').textContent = total;
        
        if (participants.length > 0) {
          const avgDist = participants.reduce((sum, p) => sum + p.distance, 0) / participants.length;
          $('adminAvgDistance').textContent = avgDist.toFixed(1) + ' km';
        }

          // Construire leaderboard local
        
        const localScans = {};
          localScans[myEmoji] = scanCount;
          participants.forEach(p => {
          if (!localScans[p.emoji]) {
              localScans[p.emoji] = 0;
            }
        });
        
        leaderboard = Object.entries(localScans)
          .map(([emoji, count]) => ({ emoji, count }))
          .sort((a, b) => b.count - a.count);
        
        const transportCounts = {};
        participants.forEach(p => {
          if (p.transport) {
            transportCounts[p.transport] = (transportCounts[p.transport] || 0) + 1;
          }
        });
        
        let statsHTML = '<h4>RÃ©partition modes de transport :</h4>';
        Object.entries(transportCounts).forEach(([mode, count]) => {
          statsHTML += `<p>${mode}: ${count} (${Math.round(count/total*100)}%)</p>`;
        });
        
        $('adminStats').innerHTML = statsHTML;
      }
      
      // Afficher le classement
      displayLeaderboard(leaderboard);
    }

    function displayLeaderboard(leaderboard) {
      const leaderboardDiv = $('leaderboard');
      leaderboardDiv.innerHTML = '';
  
      if (leaderboard.length === 0) {
        leaderboardDiv.innerHTML = '<p style="text-align: center; color: #6B7280;">Aucun participant pour le moment</p>';
        return;
      }
  
      leaderboard.slice(0, 10).forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'leaderboard-item';
    
        if (index === 0) div.classList.add('first');
        else if (index === 1) div.classList.add('second');
        else if (index === 2) div.classList.add('third');
    
        let medal = '';
        if (index === 0) medal = 'ğŸ¥‡';
        else if (index === 1) medal = 'ğŸ¥ˆ';
        else if (index === 2) medal = 'ğŸ¥‰';
        else medal = `${index + 1}.`;
    
        div.innerHTML = `
          <div style="display: flex; align-items: center;">
            <span style="font-size: 1.5rem; margin-right: 10px;">${medal}</span>
            <span class="leaderboard-emoji">${item.emoji}</span>
          </div>
          <div class="leaderboard-score">${item.count} scans</div>
        `;
    
        leaderboardDiv.appendChild(div);
      });
    }
    
    function saveGoogleScriptUrl() {
      const url = $('googleScriptUrl').value.trim();
      if (!url) {
        showError('Entrez l\'URL du script');
        return;
      }
      
      googleScriptUrl = url;
      localStorage.setItem('googleScriptUrl', url);
      
      $('scriptUrlStatus').innerHTML = '<span style="color: #06D6A0;">âœ… URL enregistrÃ©e avec succÃ¨s</span>';
      showSuccess('âœ… URL Google Sheets configurÃ©e !');
    }
    
    function resetAllData() {
      if (!confirm('âš ï¸ RÃ©initialiser TOUTES les donnÃ©es ?')) return;
      
      participants = [];
      gameTargets = [];
      scannedTargets = [];
      scanCount = 0;
      localStorage.clear();

      // RÃ©gÃ©nÃ©rer ID et emoji
      myUniqueId = generateUniqueId();
      myEmoji = generateEmojiPseudo();
      localStorage.setItem('myUniqueId', myUniqueId);
      localStorage.setItem('myEmoji', myEmoji);
      
      showSuccess('ğŸ—‘ï¸ DonnÃ©es rÃ©initialisÃ©es');
      refreshAdminStats();
    }
    
    // ========== EXPORTS ==========
    function generatePDF() {
      showSuccess('ğŸ“¥ GÃ©nÃ©ration du PDF...');
      
      setTimeout(() => {
        const content = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Rapport MobilitÃ© - GoDifferent</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    h1 { color: #1E3A5F; }
    h2 { color: #FF6B35; margin-top: 30px; }
    .section { margin: 20px 0; padding: 20px; border-left: 4px solid #06D6A0; background: #F8F9FA; }
  </style>
</head>
<body>
  <h1>ğŸš€ Rapport MobilitÃ© - GoDifferent</h1>
  
  <div class="section">
    <h2>ğŸ“ Votre profil</h2>
    <p class="emoji">${myEmoji}</p>
    <p><strong>Nombre de participants scannÃ©s :</strong> ${scanCount}</p>
    <p><strong>Adresse :</strong> ${myFullAddress}</p>
    <p><strong>Mode principal :</strong> ${myTransportMode}</p>
    ${myTransportMode2 ? `<p><strong>Mode secondaire :</strong> ${myTransportMode2} (${mode2Days}j/semaine)</p>` : ''}
    <p><strong>Heure de dÃ©part :</strong> ${myDepartureTime}</p>
  </div>
  
  <div class="section">
    <h2>ğŸ‘¥ Vos voisins proches</h2>
    <p>${participants.slice(0, 5).length} participants habitent Ã  proximitÃ©</p>
    ${participants.slice(0, 5).length > 0 ? `<p>Distance max : ${participants[Math.min(4, participants.length - 1)]?.distance.toFixed(1)} km</p>` : ''}
  </div>
  
  <div class="section">
    <h2>ğŸ’¡ Vos propositions</h2>
    <p><strong>Alternatives envisagÃ©es :</strong><br>${Object.keys(selectedAlternatives).join(', ') || 'Aucune'}</p>
    <p><strong>Vos contraintes :</strong><br>${selectedConstraints.join(', ') || 'Aucune'}</p>
    <p><strong>Leviers souhaitÃ©s :</strong><br>${selectedLevers.join(', ') || 'Aucun'}</p>
  </div>
  
  <div class="section">
    <h2>ğŸ“Š Votre engagement</h2>
    <p><strong>ProbabilitÃ© d'action :</strong> ${commitmentLevel}%</p>
  </div>
  
  <div class="section">
    <h2>ğŸ’š Ã‰conomies potentielles</h2>
    <p style="font-size: 2rem; color: #06D6A0; font-weight: bold;">${$('co2Savings').textContent} kg CO2/an</p>
    <p style="font-size: 0.9rem; color: #666;">Soit l'Ã©quivalent de ${Math.round($('co2Savings').textContent / 2.5)} arbres plantÃ©s</p>
  </div>
  
  <footer style="margin-top: 50px; text-align: center; color: #666; font-size: 0.9rem;">
    <p>Rapport gÃ©nÃ©rÃ© le ${new Date().toLocaleDateString('fr-FR')}</p>
    <p>GoDifferent - Atelier MobilitÃ© Durable</p>
    <p>Votre identifiant RGPD : ${myEmoji}</p>
  </footer>
</body>
</html>
        `;
        
        const blob = new Blob([content], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `rapport-mobilite-${myEmoji.replace(/[^\w]/g, '')}-${Date.now()}.html`;
        a.click();
        
        showSuccess('âœ… Rapport tÃ©lÃ©chargÃ© !');
      }, 1000);
    }
    
    async function exportExcel() {
      // Essayer de rÃ©cupÃ©rer depuis Google Sheets
      const sheetData = await getFromGoogleSheets();
      
      let participantsData, scansData, resultsData;
      
      if (sheetData) {
        participantsData = sheetData.participants || [];
        scansData = sheetData.scans || [];
        resultsData = sheetData.results || [];
      } else {
        // Fallback localStorage
        participantsData = participants.map(p => ({
          Emoji: p.emoji,
          ID: p.id.substring(0, 8),
          Latitude: p.lat,
          Longitude: p.lon,
          'Distance (km)': p.distance.toFixed(2),
          'Mode transport': p.transport,
          Emoji: p.emoji
        }));

      

        
        scansData = [{
          Emoji: myEmoji,
          ID: myUniqueId.substring(0, 8),
          'Nb scans': participants.length
        }];
        
        resultsData = [{
          Emoji: myEmoji,
          ID: myUniqueId.substring(0, 8),
          Score: score,
          Tentatives: 5 - attemptsLeft
        }];
      }
      
      const wb = XLSX.utils.book_new();
      const ws1 = XLSX.utils.json_to_sheet(participantsData);
      const ws2 = XLSX.utils.json_to_sheet(scansData);
      const ws3 = XLSX.utils.json_to_sheet(resultsData);
      
      XLSX.utils.book_append_sheet(wb, ws1, 'Participants');
      XLSX.utils.book_append_sheet(wb, ws2, 'Scans');
      XLSX.utils.book_append_sheet(wb, ws3, 'RÃ©sultats');
      
      XLSX.writeFile(wb, `atelier-mobilite-${Date.now()}.xlsx`);
      showSuccess('ğŸ“Š Excel exportÃ© !');
      
    }
    
    // ========== INITIALISATION ==========
    document.addEventListener('DOMContentLoaded', function() {
  checkRGPDStatus();
  restoreUserData();
  
  // Afficher l'emoji si dÃ©jÃ  gÃ©nÃ©rÃ©
  if (myEmoji && $('myEmojiDisplay')) {
    $('myEmojiDisplay').textContent = myEmoji;
  }
  
  const saveLocationBtn = $('saveLocation');
      if (saveLocationBtn) {
        saveLocationBtn.addEventListener('click', async () => {
          const userAddress = $('userAddress');
          const transportMode = $('transportMode');
          const departureTime = $('departureTime');
          
          const location = userAddress.value.trim();
          const transport = transportMode.value;
          const departure = departureTime.value;
          
          if (!location) {
            showError('Entrez votre adresse');
            return;
          }
          
          if (!transport) {
            showError('SÃ©lectionnez votre mode de transport');
            return;
          }
          
          try {
            const res = await geocode(location);
            
            if (!myUniqueId) {
  myUniqueId = localStorage.getItem('myUniqueId');
  if (!myUniqueId) {
    myUniqueId = generateUniqueId();
    localStorage.setItem('myUniqueId', myUniqueId);
  }
}

if (!myEmoji) {
  myEmoji = localStorage.getItem('myEmoji');
  if (!myEmoji) {
    myEmoji = generateEmojiPseudo();
    localStorage.setItem('myEmoji', myEmoji);
  }
}

myCoords = { lat: res.lat, lon: res.lon };
            myFullAddress = res.fullAddress;
            myTransportMode = transport;
            myDepartureTime = departure;
            
            localStorage.setItem('userCoords', JSON.stringify(myCoords));
            localStorage.setItem('transportMode', transport);
            localStorage.setItem('departureTime', departure);
            localStorage.setItem('fullAddress', myFullAddress);
            
           // ENVOI GOOGLE SHEETS
sendToGoogleSheets({
  type: 'participant',
  id: myUniqueId,
  emoji: myEmoji,
  lat: myCoords.lat,
  lon: myCoords.lon,
  address: myFullAddress,
  transport: myTransportMode,
  departureTime: myDepartureTime
});
            
            $('locationSection').style.display = 'none';
$('afterLocationSection').style.display = 'block';
$('detectedAddress').textContent = res.fullAddress;
$('myEmojiDisplay').textContent = myEmoji;

genMyQRCode();
showSuccess('âœ… Localisation enregistrÃ©e !');
            
          } catch (e) {
            showError('Erreur: ' + e.message);
          }
        });
      }
    });
    
    window.addEventListener('beforeunload', stopAllCameras);
  </script>
</body>
</html>
